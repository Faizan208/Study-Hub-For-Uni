/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a role-based access control model with user-specific data segregation.
 *
 * Data Structure:
 * - /admins/{adminId}: Stores administrator profiles, accessible only to authenticated admins.
 * - /assignments/{assignmentId}: Stores assignment details. Accessible to any authenticated user.
 * - /users/{userId}: Stores user profiles, accessible only to the user themselves.
 *
 * Key Security Decisions:
 * - Admins can only manage their own admin profile.
 * - Users can only manage their own user profile.
 * - Anyone can list assignments.
 * - Authorization Independence: The 'assignments' collection denormalizes the 'adminId' to know which admin uploaded the assignment and to authorize independently.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to administrator profiles.
     * @path /admins/{adminId}
     * @allow (get) Authenticated admin can read their own profile.
     * @allow (create) Authenticated admin can create their own profile if the adminId matches their UID.
     * @allow (update) Authenticated admin can update their own profile if the adminId matches their UID and document exists.
     * @allow (delete) Authenticated admin can delete their own profile if the adminId matches their UID and document exists.
     * @deny (get) Authenticated admin cannot read another admin's profile.
     * @deny (create) Unauthenticated user cannot create an admin profile.
     * @deny (update) Unauthenticated user cannot update an admin profile.
     * @deny (delete) Unauthenticated user cannot delete an admin profile.
     * @principle Enforces document ownership and authentication for admin profiles.
     */
    match /admins/{adminId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the document
      function isOwner(adminId) {
        return request.auth.uid == adminId;
      }

      // Allow reads (get, list) by the owner
      allow get: if isSignedIn() && isOwner(adminId);
      allow list: if false;

      // Allow creation if the user is signed in and the adminId matches their UID
      allow create: if isSignedIn() && isOwner(adminId);

      // Allow updates if the user is the owner of the document and the document exists
      allow update: if isSignedIn() && isOwner(adminId);

      // Allow deletes if the user is the owner of the document and the document exists
      allow delete: if isSignedIn() && isOwner(adminId);
    }

    /**
     * @description Controls access to assignments.
     * @path /assignments/{assignmentId}
     * @allow (get) Anyone can read an assignment.
     * @allow (list) Anyone can list assignments.
     * @allow (create) Only authenticated users can create assignments.
     * @allow (update) Only the admin who created the assignment can update it, and document exists.
     * @allow (delete) Only the admin who created the assignment can delete it, and document exists.
     * @deny (create) Unauthenticated users cannot create assignments.
     * @deny (update) Users who are not the creator of the assignment cannot update it.
     * @deny (delete) Users who are not the creator of the assignment cannot delete it.
     * @principle Allows public read access, restricts write access to the assignment creator.
     */
    match /assignments/{assignmentId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the assignment
      function isOwner(assignmentId) {
        return get(/databases/$(database)/documents/assignments/$(assignmentId)).data.adminId == request.auth.uid;
      }

      // Allow reads (get, list) by anyone
      allow get, list: if true;

      // Allow creation if the user is signed in
      allow create: if isSignedIn();

      // Allow updates if the user is the owner of the document and the document exists
      allow update: if isSignedIn() && isOwner(assignmentId);

      // Allow deletes if the user is the owner of the document and the document exists
      allow delete: if isSignedIn() && isOwner(assignmentId);
    }

    /**
     * @description Controls access to user profiles.
     * @path /users/{userId}
     * @allow (get) Authenticated user can read their own profile.
     * @allow (create) Authenticated user can create their own profile if the userId matches their UID.
     * @allow (update) Authenticated user can update their own profile if the userId matches their UID and document exists.
     * @allow (delete) Authenticated user can delete their own profile if the userId matches their UID and document exists.
     * @deny (get) Authenticated user cannot read another user's profile.
     * @deny (create) Unauthenticated user cannot create a user profile.
     * @deny (update) Unauthenticated user cannot update a user profile.
     * @deny (delete) Unauthenticated user cannot delete a user profile.
     * @principle Enforces document ownership and authentication for user profiles.
     */
    match /users/{userId} {
      // Helper function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Helper function to check if the user is the owner of the document
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Allow reads (get, list) by the owner
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;

      // Allow creation if the user is signed in and the userId matches their UID
      allow create: if isSignedIn() && isOwner(userId);

      // Allow updates if the user is the owner of the document and the document exists
      allow update: if isSignedIn() && isOwner(userId);

      // Allow deletes if the user is the owner of the document and the document exists
      allow delete: if isSignedIn() && isOwner(userId);
    }
  }
}