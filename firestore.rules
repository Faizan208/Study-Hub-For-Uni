/**
 * @fileoverview Firestore Security Rules for Prototyping.
 *
 * Core Philosophy: This ruleset prioritizes security by enforcing authentication and authorization
 * while providing flexible data shapes to accelerate prototyping. It uses an ownership model
 * for user-specific data and restricts modification of critical relational fields. Data type
 * validation is omitted for rapid iteration.
 *
 * Data Structure:
 * - /admins/{adminId}: Stores administrator profiles.
 * - /assignments/{assignmentId}: Stores assignment details. Includes denormalized 'adminId' for authorization.
 * - /quizzes/{quizId}: Stores quiz details.
 * - /practicals/{practicalId}: Stores lab practical details.
 * - /users/{userId}: Stores public profiles for regular users.
 *
 * Key Security Decisions:
 * - All write operations require authentication.
 * - User listing is disabled to protect privacy.
 * - Rules are structured to be auditable with clear helper functions.
 * - Read access to /assignments, /quizzes, and /practicals is public. Write access is restricted to authenticated users.
 *
 * Denormalization for Authorization:
 * - Assignments include 'adminId' to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's UID matches the resource's userId and the resource exists.
     */
    function isExistingOwner(userId) {
        return (isOwner(userId) && resource != null);
    }

    /**
     * @description Admin profile management.
     * @path /admins/{adminId}
     * @allow (create) - Authenticated user can create an admin profile if the uid matches the adminId.
     * @deny (create) - User cannot create an admin profile with a mismatched uid.
     * @allow (get, list, update, delete) - Only the admin can access their own profile.
     * @deny (get, list, update, delete) - Other users cannot access admin profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /admins/{adminId} {
      allow get: if isOwner(adminId);
      allow list: if false;
      allow create: if isOwner(adminId);
      allow update: if isExistingOwner(adminId);
      allow delete: if isExistingOwner(adminId);
    }

    /**
     * @description Assignment management.
     * @path /assignments/{assignmentId}
     * @allow (get, list) - Public read access to all assignments.
     * @allow (create) - Authenticated users can create assignments if the 'adminId' matches their UID.
     * @deny (create) - Users cannot create assignments with a mismatched 'adminId'.
     * @allow (update, delete) - Only the admin who created the assignment can modify or delete it.
     * @deny (update, delete) - Other users cannot modify or delete assignments.
     * @principle Allows public read access with owner-only writes.
     */
    match /assignments/{assignmentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.adminId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.adminId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.adminId == request.auth.uid;
    }

    /**
     * @description Quiz management.
     * @path /quizzes/{quizId}
     * @allow (get, list) - Public read access to all quizzes.
     * @allow (create) - Authenticated users can create quizzes.
     * @deny (create) - Requires authentication to create a quiz.
     * @allow (update, delete) - Only authenticated users can update or delete a quiz.
     * @deny (update, delete) - Requires authentication to update or delete a quiz.
     * @principle Allows public read access with owner-only writes.
     */
    match /quizzes/{quizId} {
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

      /**
       * @description Practical management.
       * @path /practicals/{practicalId}
       * @allow (get, list) - Public read access to all practicals.
       * @allow (create) - Authenticated users can create practicals.
       * @deny (create) - Requires authentication to create a practical.
       * @allow (update, delete) - Only authenticated users can update or delete a practical.
       * @deny (update, delete) - Requires authentication to update or delete a practical.
       * @principle Allows public read access with owner-only writes.
       */
      match /practicals/{practicalId} {
        allow get, list: if true;
        allow create: if isSignedIn();
        allow update: if isSignedIn();
        allow delete: if isSignedIn();
      }

    /**
     * @description User profile management.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the UID matches the userId.
     * @deny (create) - User cannot create a profile for another user.
     * @allow (get, update, delete) - Only the user can access and modify their own profile.
     * @deny (get, update, delete) - Other users cannot access user profiles.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}